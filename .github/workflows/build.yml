name: Botan ISO Builder - Sprout v1.0
on:
  workflow_dispatch: # Manuel başlatma butonu

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Kodu Çek
        uses: actions/checkout@v4

      - name: 2. Maksimum Disk Temizliği
        run: |
          # Gereksiz servisleri silerek yaklaşık 20GB+ yer açıyoruz
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/lib/jvm
          sudo docker image prune -af
          sudo docker system prune -af

      - name: 3. Çalışma Alanını Hazırla
        run: |
          sudo rm -rf work_dir out_dir
          mkdir -p $(pwd)/work_dir
          mkdir -p $(pwd)/out_dir
          # ISO içine girmemesi gereken .gitkeep dosyalarını temizle
          find airootfs/ -name ".gitkeep" -delete || true
          # Dosya izinlerini derleme için güvenli hale getir
          sudo chmod -R 755 .

      - name: 4. ISO Derleme (Docker İçinde)
        run: |
          docker run --privileged --rm \
            -v $(pwd):/iso \
            -v $(pwd)/work_dir:/work \
            -v $(pwd)/out_dir:/output \
            archlinux:latest /bin/bash -c "
              # A. Keyring ve Anahtarları Hazırla
              pacman-key --init
              pacman-key --populate archlinux
              # EndeavourOS anahtarını ekle
              pacman-key --recv-keys A367FB01AE54040E
              pacman-key --lsign-key A367FB01AE54040E
              
              # B. Derleme Araçlarını Kur
              pacman -Syu --noconfirm archiso grub mtools libisoburn dosfstools
              
              # C. Paket Önbelleğini Boşalt
              pacman -Scc --noconfirm
              
              # D. Derlemeyi Başlat
              mkarchiso -v -w /work -o /output /iso
              
              # E. Derleme Sonrası Temizlik
              rm -rf /work/*
            "

      - name: 5. GitHub Üzerinde Yedekle (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: Botan-Sprout-ISO
          path: out_dir/*.iso
          retention-days: 5
