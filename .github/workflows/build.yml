name: Botan ISO Builder - Sprout v1.0
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Kodu Çek
        uses: actions/checkout@v4

      - name: 2. Maksimum Disk Temizliği
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/lib/jvm
          sudo docker image prune -af

      - name: 3. Çalışma Alanını Hazırla
        run: |
          sudo rm -rf work_dir out_dir
          mkdir -p work_dir out_dir
          find airootfs/ -name ".gitkeep" -delete || true
          sudo chmod -R 755 .

      - name: 4. Netinstall Fixer Hazırla (Yeni Adım)
        run: |
          # Klasörleri oluştur
          mkdir -p airootfs/etc/systemd/system/multi-user.target.wants/
          
          # Sembolik linki (servis aktivasyonu) oluştur
          # Not: Link hedefi ISO içindeki mutlak yol olmalıdır (/etc/...)
          ln -sf /etc/systemd/system/botan-setup.service airootfs/etc/systemd/system/multi-user.target.wants/botan-setup.service
          
          # Script'e çalıştırma yetkisi ver
          chmod +x airootfs/usr/local/bin/botan-fixer.sh

      - name: 5. ISO Derleme (Docker İçinde)
        run: |
          docker run --privileged --rm \
            -v $(pwd):/iso \
            -v $(pwd)/work_dir:/work \
            -v $(pwd)/out_dir:/output \
            archlinux:latest /bin/bash -c "
              pacman-key --init
              pacman-key --populate archlinux
              pacman-key --recv-keys A367FB01AE54040E
              pacman-key --lsign-key A367FB01AE54040E
              
              pacman -Syu --noconfirm archiso grub mtools libisoburn dosfstools
              
              mkarchiso -v -w /work -o /output /iso
            "

      - name: 6. Final Temizliği
        if: always()
        run: sudo rm -rf work_dir

      - name: 7. GitHub Üzerinde Yedekle (Artifact)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Botan-Sprout-ISO
          path: out_dir/*.iso
          retention-days: 5
