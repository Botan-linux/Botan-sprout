name: Botan ISO Builder - Sprout v1.0
on:
  workflow_dispatch: # Manuel başlatma butonu

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Kodu Çek
        uses: actions/checkout@v4

      - name: 2. Maksimum Disk Temizliği
        run: |
          # GitHub sunucusunda yer açıyoruz
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/lib/jvm
          sudo docker image prune -af
          sudo docker system prune -af

      - name: 3. Çalışma Alanını Hazırla (Kesin Temizlik)
        run: |
          # Başlarken work_dir'i mutlaka temizliyoruz
          sudo rm -rf work_dir out_dir
          mkdir -p $(pwd)/work_dir
          mkdir -p $(pwd)/out_dir
          # .gitkeep temizliği ve izinler
          find airootfs/ -name ".gitkeep" -delete || true
          sudo chmod -R 755 .

      - name: 4. ISO Derleme (Docker İçinde)
        run: |
          docker run --privileged --rm \
            -v $(pwd):/iso \
            -v $(pwd)/work_dir:/work \
            -v $(pwd)/out_dir:/output \
            archlinux:latest /bin/bash -c "
              # A. Keyring ve Anahtarları Hazırla
              pacman-key --init
              pacman-key --populate archlinux
              pacman-key --recv-keys A367FB01AE54040E
              pacman-key --lsign-key A367FB01AE54040E
              
              # B. Araçları Kur (Docker'ın kendi içine --overwrite ile kuruyoruz)
              pacman -Syu --noconfirm --overwrite '*' archiso grub mtools libisoburn dosfstools
              
              # C. Çatışmayı Kökten Çözmek İçin mkarchiso'yu Yamala
              # Bu komut mkarchiso'nun içindeki pacman parametrelerine --overwrite ekler
              sed -i 's/pacman_options=(/pacman_options=(--overwrite \"*\" /' /usr/bin/mkarchiso
              
              # D. Derlemeyi Başlat
              mkarchiso -v -w /work -o /output /iso
            "

      - name: 5. Final Temizliği (Work Sil)
        if: always() # Hata olsa bile diski temizle
        run: |
          sudo rm -rf work_dir

      - name: 6. GitHub Üzerinde Yedekle (Artifact)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Botan-Sprout-ISO
          path: out_dir/*.iso
          retention-days: 5
